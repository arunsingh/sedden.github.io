<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Run Puppet via Cron</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

        <!-- Favicon -->
        <link href="/favicon.png" rel="icon">

        <!-- OpenID -->
        <link rel="openid2.provider" href="https://openid.stackexchange.com/openid/provider">
        <link rel="openid2.local_id" href="https://openid.stackexchange.com/user/2cd92ecb-186e-42d2-839e-e1b36cc3d6fb">


    </head>
    <body>

        <div class="site">
          <div class="header">
            <h1 class="title"><a href="/">A developer's notebook</a></h1>
            <a class="extra" href="/">home</a>
            <a class="extra" href="/about/">about</a>
            <a class="extra" href="/atom.xml">feed</a>
          </div>

          <h2>Run Puppet via Cron</h2>
<p class="meta">25 Mar 2013</p>

<div class="post">
<p>While deploying <a href="http://puppetlabs.com">Puppet</a> on several Ubuntu machines, everything was fine until Nagios started sending out warnings about high memory and high CPU usage, caused by the Puppet agent process. Related Bug-reports are:</p>

<ul>
<li><a href="https://projects.puppetlabs.com/issues/1395#change-55821">Bug #1395</a> puppet memory usage</li>
<li><a href="http://projects.puppetlabs.com/issues/12310#note-16">Bug #12310</a> Significant slow down in 2.7.10 apply</li>
<li><a href="https://bugs.launchpad.net/ubuntu/+source/puppet/+bug/995719">Bug #995719</a> process_name.rb removed in 2.7.11 but still provided by puppet-common</li>
</ul>

<p>A common workaround is to run the Puppet agent via Cron. Take a look at the <a href="http://projects.puppetlabs.com/projects/1/wiki/Cron_Patterns">Cron Patterns</a> Wiki page, but don&#39;t get too confused. Until Puppet 2.6, simply run: </p>
<div class="highlight"><pre><code class="bash language-bash" data-lang="bash">/usr/sbin/puppetd --no-daemonize --onetime
</code></pre></div>
<p>With Puppet 2.7 it slightly changed to:</p>
<div class="highlight"><pre><code class="bash language-bash" data-lang="bash">/usr/bin/puppet agent --no-daemonize --onetime
</code></pre></div>
<p>Furthermore you won&#39;t run all the agents at the same time. So the next step is to plan the execution time. To run Puppet every 30 minutes, use <code>fqdn_rand(30)</code> to generate a value between 0 and 29 for the first, and add 30 more to get the second point of time:</p>
<div class="highlight"><pre><code class="puppet language-puppet" data-lang="puppet"><span class="nv">$min1</span> <span class="o">=</span> <span class="nf">fqdn_rand</span><span class="p">(</span><span class="m">30</span><span class="p">)</span>
<span class="nv">$min2</span> <span class="o">=</span> <span class="nv">$min1</span> <span class="o">+</span> <span class="m">30</span>
</code></pre></div>
<p>The <code>fqdn_rand</code> function will generate the same value each time you call it, dependent on the FQDN of the actual host.
Finally, the file resource will look like this: </p>
<div class="highlight"><pre><code class="puppet language-puppet" data-lang="puppet"><span class="nc">file</span> <span class="p">{</span> <span class="s1">&#39;/etc/cron.d/puppet-cron&#39;</span><span class="p">:</span>
  <span class="nt">ensure</span>  <span class="p">=&gt;</span> <span class="s1">&#39;present&#39;</span><span class="p">,</span>
  <span class="nt">content</span> <span class="p">=&gt;</span> <span class="s2">&quot;$min1,$min2 * * * * root /usr/bin/puppet agent --no-daemonize --onetime</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
  <span class="nt">mode</span>    <span class="p">=&gt;</span> <span class="s1">&#39;0644&#39;</span><span class="p">,</span>
  <span class="nt">owner</span>   <span class="p">=&gt;</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span>
  <span class="nt">group</span>   <span class="p">=&gt;</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span>
<span class="p">}</span> 
</code></pre></div>
<p>As a side effect, this will solve another problem for you.
Have you ever tried to reconfigure Puppet via Puppet?
Currently there is no way telling Puppet to stop, re-read it&#39;s configuration and start again (e.g. via sending the SIGHUP signal). This related Bug-report was added two years ago:</p>

<ul>
<li><a href="http://projects.puppetlabs.com/issues/7273">Bug #7273</a> - Add additional signals for restarting Puppet agent runs</li>
</ul>

</div>

<div>





	<p><a href="/blog/2013/03/26/openwrt-ipv6-forwarding">Forwarding IPv6 Traffic from WAN to LAN with OpenWRT Â»</a></p>


</div>


          <div class="footer">
            <div class="contact">
              <p>
                Stefan Jenkner<br />
                stefan@jenkner.org
              </p>
            </div>
            <div class="contact">
              <p>
                <a href="https://github.com/sedden">github.com/sedden</a><br />
                <a href="https://twitter.com/sedden">twitter.com/sedden</a> 
                <a href="https://alpha.app.net/sedden">alpha.app.net/sedden</a><br />
              </p>
            </div>
          </div>
        </div>

    </body>
</html>
